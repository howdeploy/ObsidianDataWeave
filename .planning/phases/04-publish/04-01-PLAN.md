---
phase: 04-publish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - install.sh
  - LICENSE
  - .gitignore
autonomous: true
requirements:
  - DIST-02
must_haves:
  truths:
    - "Running bash install.sh on a system with pacman detects Arch and uses --break-system-packages for pip"
    - "Running bash install.sh on a system with brew uses pip3 install without --break-system-packages"
    - "Running bash install.sh twice does not duplicate config.toml, skill registration, or vault folders"
    - "Running bash install.sh creates config.toml interactively from config.example.toml"
    - "Running bash install.sh registers ObsidianDataWeave in ~/.claude/CLAUDE.md without duplicates"
    - "Running bash install.sh creates vault subfolders read from config.toml"
    - "No personal vault paths or secrets exist in any tracked file"
  artifacts:
    - path: "install.sh"
      provides: "Cross-platform idempotent installer"
      min_lines: 100
    - path: "LICENSE"
      provides: "MIT license"
      min_lines: 15
    - path: ".gitignore"
      provides: "Comprehensive gitignore covering staging artifacts, editors, venvs"
      contains: "*-parsed.json"
  key_links:
    - from: "install.sh"
      to: "config.example.toml"
      via: "sed substitution to create config.toml"
      pattern: "sed.*config\\.example\\.toml.*config\\.toml"
    - from: "install.sh"
      to: "~/.claude/CLAUDE.md"
      via: "append skill registration with grep -qF guard"
      pattern: "grep.*ObsidianDataWeave"
    - from: "install.sh"
      to: "config.toml"
      via: "python3 tomllib to read vault_path and folder names"
      pattern: "tomllib\\.load"
---

<objective>
Create the cross-platform install.sh, MIT license, and hardened .gitignore. After this plan, a user on Manjaro, Ubuntu, Fedora, or macOS can run `bash install.sh` and get a fully configured ObsidianDataWeave setup: rclone installed, python-docx installed, config.toml created interactively, vault folders created, and Claude Code skill registered.

Purpose: DIST-02 requires Claude to be able to clone the repo, install dependencies, create config, and register the skill. install.sh is the single entry point that does all of this.
Output: install.sh, LICENSE, updated .gitignore
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-publish/04-RESEARCH.md
@.planning/phases/04-publish/04-CONTEXT.md
@config.example.toml
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: install.sh cross-platform installer</name>
  <files>install.sh</files>
  <action>
Create install.sh with `#!/usr/bin/env bash` and `set -euo pipefail`. Structure:

1. **REPO_DIR detection**: `REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"` then `cd "$REPO_DIR"`.

2. **detect_pkg_manager()**: Returns pacman / brew / apt / dnf / unknown. Check `command -v` in order: pacman, brew, apt-get, dnf. Print detected manager at start.

3. **Python version check**: Run `python3 --version`, parse major.minor. If < 3.10, error and exit. If < 3.11, warn: "Python 3.10 detected. Scripts will work but consider upgrading to 3.11+ for native tomllib support." Do NOT fail for 3.10.

4. **install_rclone()**: Guard with `command -v rclone`. If present, print version and return. Otherwise install via detected package manager. For "unknown", use `curl https://rclone.org/install.sh | sudo bash`.

5. **install_python_docx()**: Guard with `python3 -c "import docx" 2>/dev/null`. If present, return. For pacman: first `sudo pacman -S --noconfirm python-lxml 2>/dev/null || true`, then `pip3 install --break-system-packages python-docx`. For all others: `pip3 install python-docx`. If Python < 3.11, also install tomli: same pip pattern with --break-system-packages for pacman.

6. **create_config()**: Guard with `[ -f config.toml ]` — if exists, print "config.toml already exists — skipping" and return. Otherwise:
   - `read -rp "Obsidian vault path (absolute): " VAULT_PATH`
   - `read -rp "rclone remote name [gdrive:]: " RCLONE_REMOTE` with default `RCLONE_REMOTE="${RCLONE_REMOTE:-gdrive:}"`
   - Ensure remote name ends with colon: `[[ "$RCLONE_REMOTE" != *: ]] && RCLONE_REMOTE="${RCLONE_REMOTE}:"`
   - Use `sed` to substitute placeholders in config.example.toml into config.toml
   - After creation, validate with `rclone listremotes | grep -qF "${RCLONE_REMOTE}"` — warn (not fail) if remote not found

7. **create_vault_folders()**: Read vault_path, notes_folder, moc_folder, source_folder from config.toml using inline `python3 -c` with tomllib (with tomli fallback). Check `[ -d "$VAULT_PATH" ]` — if vault path doesn't exist, warn but don't fail. If it exists, `mkdir -p` for each subfolder. Print each folder status.

8. **register_claude_skill()**: Check `~/.claude/CLAUDE.md` exists — create `~/.claude/` dir if needed. Check for marker `## ObsidianDataWeave Pipeline` with `grep -qF`. If found, skip. Otherwise `cat >> "$CLAUDE_MD"` the skill section with trigger phrases ("process [document].docx", "atomize document", "run the pipeline", "import to Obsidian") and the `cd $REPO_DIR && python3 scripts/process.py` command pattern. Use `$REPO_DIR` variable (evaluated at install time, NOT at runtime).

9. **Main flow**: Call each function in order with section headers (`echo ""`; `echo "=== Step N: Description ==="`). End with summary: "Setup complete. Next: open README.md for Quick Start commands."

Make install.sh executable with chmod +x at the end of the task.

Key pitfall avoidances (from research):
- pip --break-system-packages ONLY for pacman-detected systems
- grep -qF guard prevents duplicate CLAUDE.md registrations
- config.toml guard prevents overwriting user's real config
- Folder names read from config.toml, NOT hardcoded
- vault_path validation warns but doesn't fail (user may set up vault later)
  </action>
  <verify>
Run `bash -n install.sh` to check syntax. Verify the file is executable. Grep for key patterns: "break-system-packages", "grep -qF", "detect_pkg_manager", "config.toml already exists", "tomllib".
  </verify>
  <done>install.sh passes bash syntax check, handles all 5 package managers (pacman/brew/apt/dnf/unknown), is idempotent (all 6 steps guarded), and registers Claude Code skill without duplicates.</done>
</task>

<task type="auto">
  <name>Task 2: MIT license and .gitignore hardening</name>
  <files>LICENSE, .gitignore</files>
  <action>
1. **LICENSE**: Create MIT license file. Copyright holder: "ObsidianDataWeave Contributors". Year: 2026. Standard MIT text.

2. **.gitignore update**: Read existing .gitignore first. Add these patterns (from research recommendations) BELOW the existing content, with a blank line separator and comment headers:

```
# Virtual environments
.venv/
venv/
env/

# Editor/IDE configs
.idea/
.vscode/
*.swp
*.swo

# Staging artifacts (safety net if staging_dir changed from /tmp/)
*-parsed.json
*-atom-plan.json
proposed-tags.md

# Logs
*.log
```

Do NOT remove or modify any existing .gitignore entries. Only append new patterns.

3. **Security verification**: Run `git ls-files` and check that no tracked file contains hardcoded personal vault paths. The project is already clean per research findings — this is a confirmation step only. If any issue found, report it but do NOT modify source files (out of scope for this task).
  </action>
  <verify>
Verify LICENSE exists and contains "MIT". Verify .gitignore contains all new patterns: `grep -c "atom-plan.json" .gitignore` returns 1. Run `git ls-files` and confirm config.toml and processed.json are NOT in the tracked list.
  </verify>
  <done>MIT LICENSE file exists. .gitignore covers virtual environments, editor configs, staging artifacts, and logs. No personal paths exist in any tracked file.</done>
</task>

</tasks>

<verification>
1. `bash -n install.sh` — syntax check passes
2. `head -1 install.sh` — shows `#!/usr/bin/env bash`
3. `ls -la install.sh` — shows executable permission
4. `grep -c "detect_pkg_manager" install.sh` — returns 1+
5. `grep -c "break-system-packages" install.sh` — returns 1+
6. `grep -c "config.toml already exists" install.sh` — returns 1+
7. `grep -c "ObsidianDataWeave Pipeline" install.sh` — returns 1+
8. `cat LICENSE | head -3` — shows MIT License header
9. `grep "atom-plan.json" .gitignore` — pattern present
10. `git ls-files | grep -c "config.toml"` — returns 0 (not tracked)
</verification>

<success_criteria>
- install.sh is a complete, idempotent, cross-platform installer that handles pacman/brew/apt/dnf/unknown
- All 6 installation steps have idempotency guards (command -v, -f, grep -qF)
- MIT LICENSE file is present
- .gitignore is comprehensive (original entries preserved, new patterns added)
- No personal paths or secrets exist in tracked files
</success_criteria>

<output>
After completion, create `.planning/phases/04-publish/04-01-SUMMARY.md`
</output>
