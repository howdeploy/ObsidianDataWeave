---
phase: 03-writers
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/generate_notes.py
autonomous: true
requirements:
  - VAULT-04

must_haves:
  truths:
    - "Running generate_notes.py on an atom plan JSON creates .md files in staging directory"
    - "Each .md file has correct YAML frontmatter with tags, date, source_doc, note_type"
    - "No file is written to the vault — only to staging"
    - "Cyrillic filenames work correctly without encoding errors"
    - "Source_doc values with colons are properly double-quoted in frontmatter"
  artifacts:
    - path: "scripts/generate_notes.py"
      provides: "Atom plan JSON to .md file renderer"
      min_lines: 80
      exports: ["main"]
  key_links:
    - from: "scripts/generate_notes.py"
      to: "atom-plan.json (Phase 2 output)"
      via: "json.loads on input file path from CLI argument"
      pattern: "json\\.loads.*read_text"
    - from: "scripts/generate_notes.py"
      to: "config.toml"
      via: "tomllib.load for staging_dir"
      pattern: "tomllib\\.load"
    - from: "scripts/generate_notes.py"
      to: "/tmp/dw/staging/*.md"
      via: "Path.write_text for each note"
      pattern: "write_text.*encoding"
---

<objective>
Create generate_notes.py that reads an atom plan JSON (Phase 2 output) and renders each note entry into a .md file with YAML frontmatter in the staging directory.

Purpose: This is the first half of the Phase 3 writer pipeline. It converts the structured atom plan into individual Obsidian-compatible markdown files, but writes ONLY to staging (never to the vault). vault_writer.py (Plan 02) handles the vault commit.

Output: scripts/generate_notes.py — callable as `python3 scripts/generate_notes.py <atom-plan.json>`, prints staging directory path to stdout for process.py chaining.
</objective>

<execution_context>
@/home/kosya/.claude/get-shit-done/workflows/execute-plan.md
@/home/kosya/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-writers/03-CONTEXT.md
@.planning/phases/03-writers/03-RESEARCH.md
@scripts/atomize.py
@config.example.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate_notes.py with frontmatter rendering and filename sanitization</name>
  <files>scripts/generate_notes.py</files>
  <action>
Create scripts/generate_notes.py (~100-120 lines) with the following functions and behavior:

**CLI interface:**
- `argparse` with one positional argument: path to atom plan JSON
- Prints staging directory path to stdout (for process.py chaining in Plan 02)
- All diagnostics (progress, counts) go to stderr

**Functions to implement:**

1. `load_config() -> dict` — Read config.toml via tomllib (stdlib). If config.toml missing, fall back to `{"rclone": {"staging_dir": "/tmp/dw/staging"}}` with stderr warning. Same pattern as atomize.py.

2. `sanitize_filename(title: str, max_bytes: int = 200) -> str` — Replace Obsidian-forbidden characters (`\ / * " < > : | ?`) with `-`. Remove NUL bytes. Truncate to max_bytes in UTF-8 (not chars) using `encoded[:max_bytes].decode("utf-8", errors="ignore")`. Default 200 bytes leaves room for `.md` extension + safety margin within ext4's 255-byte limit. Strip leading/trailing whitespace.

3. `render_note_md(note: dict) -> str` — Build .md content with YAML frontmatter. Fixed 4-field schema:
   - `tags:` as YAML list (one `  - tag` per line)
   - `date:` as-is from the note dict
   - `source_doc:` ALWAYS double-quoted to handle colons in titles (e.g., `"Smart Connections: Интеллектуальный мозг.docx"`). Escape embedded double-quotes with `\"`.
   - `note_type:` as-is
   - Then blank line, `# {title}`, blank line, body text.
   - Use string interpolation, NOT PyYAML.

4. `main()` — Load atom plan JSON, load config, derive staging_dir, mkdir -p staging_dir. Iterate over `plan["notes"]`, for each note: sanitize title to filename, append `.md`, call render_note_md(), write to staging_dir/filename. Count atomic vs MOC notes. Print summary to stderr (`"Generated N .md files in staging (X atomic + Y MOC)"`). Print staging_dir path to stdout.

**Contract with atom plan JSON (from Phase 2 atomize.py):**
Each note in `plan["notes"]` has: `id`, `title`, `note_type` ("atomic"|"moc"|"source"), `tags` (list), `source_doc` (string), `date` (ISO string), `body` (string), `proposed_new_tags` (list).

**Critical constraints:**
- NEVER import or reference vault_path — this script writes ONLY to staging_dir
- Follow the established tomllib import pattern from atomize.py (try tomllib, fallback tomli)
- PROJECT_ROOT = Path(__file__).parent.parent (same as atomize.py)
  </action>
  <verify>
Create a mock atom plan JSON in /tmp/dw/test-atom-plan.json with 2 atomic notes and 1 MOC note (use Russian titles with colons to test edge cases). Run:
```
python3 scripts/generate_notes.py /tmp/dw/test-atom-plan.json
```
Verify:
1. Exit code 0
2. stdout contains staging directory path (e.g., /tmp/dw/staging)
3. .md files exist in staging directory with correct count (3 files)
4. Each .md file starts with `---` frontmatter block
5. source_doc value is double-quoted in frontmatter
6. Cyrillic filenames are readable (ls the staging dir)
7. No file exists outside staging (grep vault_path in the script should find nothing)
  </verify>
  <done>
generate_notes.py reads atom plan JSON and produces .md files in staging with correct YAML frontmatter. Filenames handle Cyrillic and special characters. Source_doc is double-quoted. Only staging_dir is written to. Staging dir path printed to stdout.
  </done>
</task>

</tasks>

<verification>
1. `python3 scripts/generate_notes.py /tmp/dw/test-atom-plan.json` exits 0 and prints staging path to stdout
2. `ls /tmp/dw/staging/*.md` shows 3 .md files (2 atomic + 1 MOC)
3. `head -10 /tmp/dw/staging/*.md` shows correct YAML frontmatter with double-quoted source_doc
4. `grep -r "vault_path" scripts/generate_notes.py` returns nothing (script never touches vault)
5. `python3 -c "import scripts.generate_notes"` does not crash (valid Python)
</verification>

<success_criteria>
- generate_notes.py converts any valid atom plan JSON into correctly formatted .md files in staging
- YAML frontmatter has all 4 fields (tags, date, source_doc, note_type) with proper quoting
- Filename sanitization handles Cyrillic, colons, and long titles without errors
- Script follows project conventions: tomllib config, PROJECT_ROOT, stdout/stderr separation
</success_criteria>

<output>
After completion, create `.planning/phases/03-writers/03-01-SUMMARY.md`
</output>
